<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mister White</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#07121a">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root{
  --bg:#03060a;
  --card:#0e1418;
  --muted:#90a7b5;
  --accent:#00E1FF; /* neon blu */
  --danger:#ff4d6d;
  --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#02040a,#051225);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#E6F7FF}
.container{max-width:760px;margin:12px auto;padding:12px}
.header{display:flex;justify-content:space-between;align-items:center;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
.title{display:flex;gap:12px;align-items:center}
.logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#7ff7ff);display:flex;align-items:center;justify-content:center;color:#001020;font-weight:800}
.h1{font-size:18px;font-weight:700}
.sub{font-size:12px;color:var(--muted)}

.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:16px;border-radius:12px;margin-top:12px;border:1px solid rgba(255,255,255,0.02)}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input[type="text"], input[type="number"], input[type="search"]{
  width:100%;padding:12px;border-radius:10px;border:none;background:rgba(255,255,255,0.02);color:#E6F7FF;font-size:16px;outline:none;
}
.row{display:flex;gap:10px;align-items:center}
.small{font-size:13px;color:var(--muted)}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.button{
  background:linear-gradient(90deg,var(--accent),#7ff7ff);
  color:#012;padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer;
}
.button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(0,225,255,0.06)}
.button.danger{background:linear-gradient(90deg,var(--danger),#ff7e9a);color:#140005}
.toggle{display:inline-flex;align-items:center;gap:8px}
.switch{
  width:46px;height:26px;border-radius:18px;background:rgba(255,255,255,0.05);position:relative;cursor:pointer;border:1px solid rgba(255,255,255,0.02)
}
.knob{width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;left:3px;top:3px;transition:left .14s}
.switch.on{background:linear-gradient(90deg,var(--accent),#60f0ff)}
.switch.on .knob{left:23px;background:#012}

.screen{display:none}
.screen.active{display:block}

/* list */
.list{list-style:none;padding:0;margin:0}
.list li{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}
.role{font-size:13px;color:var(--muted)}
.hint-pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(0,225,255,0.04);color:var(--accent);font-weight:700;border:1px solid rgba(0,225,255,0.04)}

/* footer */
.footer{margin-top:12px;font-size:13px;color:var(--muted);text-align:center}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">
      <div class="logo">MW</div>
      <div>
        <div class="h1">Mister White</div>
      </div>
    </div>
    <div class="small">v1.3</div>
  </div>

  <!-- SETUP -->
  <div id="setupScreen" class="card screen active">
    <label>Inserisci i nomi dei giocatori (separati da virgola)</label>
    <input id="nameInput" type="text" placeholder="Es: Luca, Marco, Sara">
    <div style="display:flex;gap:10px;margin-top:10px">
      <div style="flex:1">
        <label>Numero Mister White</label>
        <input id="numWhite" type="number" min="0" value="1">
      </div>
      <div style="flex:1">
        <label>Numero Infiltrati</label>
        <input id="numInfiltrati" type="number" min="0" value="1">
      </div>
    </div>

    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px">
      <div class="toggle">
        <div style="font-size:13px;color:var(--muted);margin-right:8px">Indizio a Mister White</div>
        <div id="hintSwitch" class="switch" onclick="toggleHint()"><div class="knob"></div></div>
      </div>
    </div>

    <div class="controls" style="margin-top:14px">
      <button class="button" onclick="startGame()">üé≤ Inizia la partita</button>
      <button class="button ghost" onclick="openWordManager()">üìù Visualizza parole</button>
    </div>
   </div>

  <!-- ROLE -->
  <div id="roleScreen" class="card screen">
    <div style="margin-bottom:8px" class="small">Mostra il ruolo</div>
    <div style="text-align:center">
      <div id="playerName" style="font-weight:800;font-size:20px;margin-bottom:12px"></div>
      <button id="revealBtn" class="button" onclick="revealRole()">Mostra ruolo</button>
      <div id="roleText" style="margin-top:12px;font-weight:800;font-size:18px;color:var(--accent);display:none"></div>
      <div style="margin-top:12px">
        <button id="nextBtn" class="button ghost" style="display:none" onclick="nextPlayer()">‚û°Ô∏è Prossimo</button>
      </div>
    </div>
  </div>

  <!-- READY (order + starting player) -->
  <div id="readyScreen" class="card screen">
    <h3 style="margin-top:0">Tutti hanno visto il ruolo</h3>
    <div class="small">Ordine di gioco</div>
    <div id="orderList" style="margin:10px 0"></div>
    <div class="small">Inizia</div>
    <div id="startingPlayer" style="font-weight:800;color:var(--accent);margin-top:6px"></div>

    <div style="margin-top:12px" class="controls">
      <button class="button" onclick="beginDiscussion()">‚û°Ô∏è Mostra risultati </button>
      <button class="button ghost" onclick="reviewRound()">üîÅ Rivedi le parole (ripeti giro)</button>
    </div>
  </div>

  <!-- SUMMARY -->
  <div id="summaryScreen" class="card screen">
    <h3 style="margin-top:0">Riepilogo</h3>
    <ul id="summaryList" class="list" style="margin-top:8px"></ul>
    <div style="margin-top:12px" class="controls">
      <button class="button" onclick="restart()">üîÑ Nuova partita</button>
    </div>
  </div>

  <!-- WORD MANAGER (view + remove only) -->
  <div id="wordManagerScreen" class="card screen">
    <h3 style="margin-top:0">Elenco parole (tema incluso)</h3>
    <ul id="wordList" class="list" style="margin-top:8px"></ul>
    <div style="margin-top:12px" class="controls">
      <button class="button ghost" onclick="closeWordManager()">Chiudi</button>
    </div>
    <div class="small" style="margin-top:8px">Puoi rimuovere coppie, ma non aggiungerne dall'app.</div>
  </div>

  <!-- REVIEW (single name -> shows role/word for that name if game started) -->
  <div id="reviewScreen" class="card screen">
    <h3 style="margin-top:0">Rivedi la tua parola</h3>
    <label>Inserisci il tuo nome (esattamente come nella lista)</label>
    <input id="reviewName" type="text" placeholder="Es: Luca">
    <div style="margin-top:10px" class="controls">
      <button class="button" onclick="doReview()">Mostra la mia parola</button>
      <button class="button ghost" onclick="closeReview()">Chiudi</button>
    </div>
    <div id="reviewResult" style="margin-top:12px;font-weight:700;color:var(--accent)"></div>
  </div>

</div>

<script>
/* =========================
   DATI PAROLE (format: {main, infiltrator, tema})
   Se ci sono parole salvate in localStorage le usiamo (ma controlleremo formato)
   ========================= */
const defaultWords = [
{main:"Anello", infiltrator:"Matrimonio", tema:"Chiesa"},
{main:"Bara", infiltrator:"Urna", tema:"Cimitero"},
{main:"Vino", infiltrator:"Aceto", tema:"Liquidi"},
{main:"Ospedale", infiltrator:"Pronto Soccorso", tema:"Salute"},
{main:"Tribunale", infiltrator:"Prigione", tema:"Legge"},
{main:"Pasticceria", infiltrator:"Panetteria", tema:"Negozi"},
{main:"Palestra", infiltrator:"Spogliatoio", tema:"Sport"},
{main:"Stazione", infiltrator:"Aeroporto", tema:"Viaggi"},
{main:"Scuola", infiltrator:"Biblioteca", tema:"Istruzione"},
{main:"Circo", infiltrator:"Luna Park", tema:"Divertimento"},
{main:"Giardino", infiltrator:"Parco", tema:"Natura"},
{main:"Cucina", infiltrator:"Ristorante", tema:"Cibo"},
{main:"Stalla", infiltrator:"Pollaio", tema:"Fattoria"},
{main:"Ufficio", infiltrator:"Banca", tema:"Lavoro"},
{main:"Soffitta", infiltrator:"Cantina", tema:"Casa"},
{main:"Garage", infiltrator:"Parcheggio", tema:"Auto"},
{main:"Teatro", infiltrator:"Concerto", tema:"Cultura"},
{main:"Spiaggia", infiltrator:"Piscina", tema:"Estate"},
{main:"Bosco", infiltrator:"Giungla", tema:"Ambiente"},
{main:"Vulcano", infiltrator:"Terremoto", tema:"Natura"},
{main:"Prete", infiltrator:"Suora", tema:"Religione"},
{main:"Medico", infiltrator:"Veterinario", tema:"Lavoro"},
{main:"Soldato", infiltrator:"Poliziotto", tema:"Divise"},
{main:"Contadino", infiltrator:"Giardiniere", tema:"Lavoro"},
{main:"Autobus", infiltrator:"Pullman", tema:"Trasporti"},
{main:"Traghetto", infiltrator:"Crociera", tema:"Mare"},
{main:"Ghiacciaio", infiltrator:"Iceberg", tema:"Freddo"},
{main:"Deserto", infiltrator:"Spiaggia", tema:"Sabbia"},
{main:"Vigile del Fuoco", infiltrator:"Protezione Civile", tema:"Soccorso"},
{main:"Stadio", infiltrator:"Arena", tema:"Eventi"},
{main:"Palcoscenico", infiltrator:"Backstage", tema:"Spettacolo"},
{main:"Farmacia", infiltrator:"Erboristeria", tema:"Salute"},
{main:"Mercato", infiltrator:"Supermercato", tema:"Spesa"},
{main:"Miniera", infiltrator:"Grotta", tema:"Sottosuolo"},
{main:"Cattedrale", infiltrator:"Castello", tema:"Architettura"},
{main:"Tenda", infiltrator:"Bungalow", tema:"Camping"},
{main:"Aereo", infiltrator:"Elicottero", tema:"Volo"},
{main:"Stufa", infiltrator:"Camino", tema:"Riscaldamento"},
{main:"Doccia", infiltrator:"Vasca", tema:"Bagno"},
{main:"Lavatrice", infiltrator:"Lavastoviglie", tema:"Elettrodomestici"},
{main:"Quadro", infiltrator:"Scultura", tema:"Arte"},
{main:"Pianoforte", infiltrator:"Arpa", tema:"Musica"},
{main:"Telescopio", infiltrator:"Microscopio", tema:"Scienza"},
{main:"Bussola", infiltrator:"Mappa", tema:"Orientamento"},
{main:"Arco", infiltrator:"Fionda", tema:"Armi"},
{main:"Scacchi", infiltrator:"Carte", tema:"Giochi"},
{main:"Albergo", infiltrator:"Ostello", tema:"Alloggio"},
{main:"Ponte", infiltrator:"Galleria", tema:"Strade"},
{main:"Faro", infiltrator:"Mulino", tema:"Strutture"},
{main:"Zoo", infiltrator:"Acquario", tema:"Animali"}
];

let stored = JSON.parse(localStorage.getItem('gameWords'));
let words = Array.isArray(stored) && stored.length>0 ? stored : defaultWords.slice();

/* =========================
   STATO GIOCO
   ========================= */
let players = []; // names array (shuffled)
let roles = [];   // array of {name, role}
let currentWords = []; // array of strings per role index
let currentIndex = 0;
let hintEnabled = JSON.parse(localStorage.getItem('hintEnabled')) || false;
setHintUI();

/* =========================
   UI helpers
   ========================= */
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* hint toggle */
function setHintUI(){
  const el = document.getElementById('hintSwitch');
  if(!el) return;
  if(hintEnabled) el.classList.add('on'); else el.classList.remove('on');
}
function toggleHint(){
  hintEnabled = !hintEnabled;
  localStorage.setItem('hintEnabled', JSON.stringify(hintEnabled));
  setHintUI();
}

/* =========================
   WORD MANAGER (view + remove)
   ========================= */
function renderWordList(){
  const ul = document.getElementById('wordList');
  ul.innerHTML = '';
  words.forEach((w,i)=>{
    const li = document.createElement('li');
    const left = document.createElement('div');
    left.innerHTML = `<strong>${w.main}</strong> ‚Üí <span class="small">${w.infiltrator}</span><div class="small" style="margin-top:6px;color:var(--muted)">Tema: ${w.tema}</div>`;
    const right = document.createElement('div');
    const btn = document.createElement('button');
    btn.className = 'button ghost';
    btn.textContent = 'Rimuovi';
    btn.onclick = ()=>{ if(confirm('Rimuovere questa coppia?')){ words.splice(i,1); localStorage.setItem('gameWords', JSON.stringify(words)); renderWordList(); } };
    right.appendChild(btn);
    li.appendChild(left);
    li.appendChild(right);
    ul.appendChild(li);
  });
}
function openWordManager(){ renderWordList(); showScreen('wordManagerScreen'); }
function closeWordManager(){ showScreen('setupScreen'); }

/* =========================
   START GAME
   ========================= */
function startGame(){
  const raw = document.getElementById('nameInput').value || '';
  let names = raw.split(',').map(s=>s.trim()).filter(s=>s.length>0);
  const w = parseInt(document.getElementById('numWhite').value) || 0;
  const inf = parseInt(document.getElementById('numInfiltrati').value) || 0;
  if(names.length === 0){ alert('Aggiungi almeno un giocatore'); return; }
  if(w + inf > names.length){ alert('Troppi ruoli speciali per il numero di giocatori'); return; }

  // shuffle names
  players = shuffle(names.slice());

  // prepare roles list and shuffle roles
  const rlist = [];
  for(let i=0;i<w;i++) rlist.push('Mister White');
  for(let i=0;i<inf;i++) rlist.push('Infiltrato');
  while(rlist.length < players.length) rlist.push('Normale');
  const shuffledRoles = shuffle(rlist.slice());

  roles = players.map((nm, idx)=>({ name: nm, role: shuffledRoles[idx] }));

  // choose one pair for this round (keeps pairing coherent)
  const pair = words[Math.floor(Math.random() * words.length)];
  // prepare currentWords aligned with roles array
  currentWords = roles.map(r=>{
    if(r.role === 'Mister White') return ''; // Mister White sees no word (but may see Theme)
    if(r.role === 'Infiltrato') return pair.infiltrator;
    return pair.main;
  });

  // save current pair to session for hint purposes
  window._currentPair = pair;

  currentIndex = 0;
  updateRoleScreen();
  showScreen('roleScreen');
}

/* =========================
   ROLE FLOW
   ========================= */
function updateRoleScreen(){
  if(!roles || roles.length===0) return;
  const name = roles[currentIndex].name;
  document.getElementById('playerName').innerText = name;
  document.getElementById('roleText').style.display = 'none';
  document.getElementById('revealBtn').style.display = 'inline-block';
  document.getElementById('nextBtn').style.display = 'none';
}

function revealRole(){
  const r = roles[currentIndex];
  const el = document.getElementById('roleText');

  if(r.role === 'Mister White'){
    // must always show explicit text "SEI MISTER WHITE!"
    if(hintEnabled && window._currentPair && window._currentPair.tema){
      el.innerText = `‚ùì SEI MISTER WHITE!\nTema: ${window._currentPair.tema}`;
    } else {
      el.innerText = `‚ùì SEI MISTER WHITE!\nProva a indovinare la parola degli altri.`;
    }
  } else {
    // Normale & Infiltrato see their assigned word; infiltrato does not see role label
    el.innerText = `Parola: ${currentWords[currentIndex]}`;
  }

  el.style.whiteSpace = 'pre-line';
  el.style.display = 'block';
  document.getElementById('revealBtn').style.display = 'none';
  document.getElementById('nextBtn').style.display = 'inline-block';
}

function nextPlayer(){
  currentIndex++;
  if(currentIndex >= roles.length){
    // prepare play order (reshuffle players for play) and show starter
    const playOrder = shuffle(players.slice());
    const orderListEl = document.getElementById('orderList');
    orderListEl.innerHTML = playOrder.map((n,i)=>`<div style="padding:8px;background:rgba(255,255,255,0.02);border-radius:8px;margin-bottom:6px"><strong style="color:var(--accent)">${i+1}.</strong> <span style="margin-left:8px">${n}</span></div>`).join('');
    document.getElementById('startingPlayer').innerText = playOrder[0];
    // store playOrder for potential use
    window._playOrder = playOrder;
    showScreen('readyScreen');
  } else {
    updateRoleScreen();
  }
}

/* =========================
   BEGIN DISCUSSION & SUMMARY
   ========================= */
function beginDiscussion(){
  const ul = document.getElementById('summaryList');
  ul.innerHTML = '';
  roles.forEach((r, idx)=>{
    const li = document.createElement('li');
    const word = r.role === 'Mister White' ? '-' : currentWords[idx];
    li.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${r.name}</strong><div class="role">${r.role}</div></div><div style="font-weight:800;color:var(--accent)">${word}</div></div>`;
    ul.appendChild(li);
  });
  showScreen('summaryScreen');
}

/* =========================
   REVIEW: restart the reveal round (same roles/words)
   ========================= */
function reviewRound(){
  if(!roles || roles.length===0){ alert('Partita non avviata'); return; }
  currentIndex = 0;
  updateRoleScreen();
  showScreen('roleScreen');
}

/* quick review single-person */
function openReview(){ document.getElementById('reviewName').value=''; document.getElementById('reviewResult').innerText=''; showScreen('reviewScreen'); }
function closeReview(){ showScreen('setupScreen'); }
function doReview(){
  const q = document.getElementById('reviewName').value.trim();
  if(!q){ alert('Inserisci il tuo nome'); return; }
  if(!roles || roles.length===0){ document.getElementById('reviewResult').innerText = 'Partita non avviata'; return; }
  const idx = roles.findIndex(r=> r.name.toLowerCase() === q.toLowerCase());
  if(idx === -1){ document.getElementById('reviewResult').innerText = 'Nome non trovato (controlla ortografia)'; return; }
  const r = roles[idx];
  let text = '';
  if(r.role === 'Mister White'){
    if(hintEnabled && window._currentPair && window._currentPair.tema){
      text = `‚ùì SEI MISTER WHITE!\nTema: ${window._currentPair.tema}`;
    } else {
      text = '‚ùì SEI MISTER WHITE!\nProva a indovinare la parola degli altri.';
    }
  } else {
    text = `Sei ${r.role} ‚Äî Parola: ${currentWords[idx]}`;
  }
  document.getElementById('reviewResult').innerText = text;
}

/* =========================
   RESTART
   ========================= */
function restart(){
  // clear roles but keep player list in input for convenience
  roles = []; currentWords = []; currentIndex = 0; window._currentPair = null;
  showScreen('setupScreen');
}

/* =========================
   UTIL
   ========================= */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

/* =========================
   INIT
   ========================= */
(function init(){
  // ensure words stored shape; if found in localStorage but missing tema, map default tema
  const stored = JSON.parse(localStorage.getItem('gameWords'));
  if(Array.isArray(stored) && stored.length>0){
    // replace only if every item has main+infiltrator+tema
    const ok = stored.every(w => w && typeof w.main === 'string' && typeof w.infiltrator === 'string' && typeof w.tema === 'string');
    if(ok) words = stored.slice();
    else localStorage.removeItem('gameWords');
  } else {
    // ensure initial words array is saved so user can remove later
    localStorage.setItem('gameWords', JSON.stringify(words));
  }
  setHintUI();
})();
  
/* =========================
   Service Worker registration if available
   ========================= */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js').catch(()=>{/*silent*/});
}
</script>
</body>
</html>
